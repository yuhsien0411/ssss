# 交易策略盈利能力分析

## 當前虧損情況

根據您提供的數據：
- **24小時 PnL**: -$11.35
- **回報率**: -2.27%
- **交易量**: $30,187.44
- **平均每小時虧損**: -$0.47
- **Sharpe Ratio**: -8.00 (極差)

## 成本分析

### 單筆交易成本

假設一對交易（開倉 + 平倉）：

1. **開倉**：Maker 訂單
   - Maker 費率：0.002%
   - 成本：$0.01 * 0.00002 = $0.000002 (極小)

2. **平倉**：可能的情況
   - **情況 A**：Maker 訂單成功 (理想情況)
     - Maker 費率：0.002%
     - 成本：$0.01 * 0.00002 = $0.000002
     - **總成本 (Maker+Maker)**: ~$0.000004
   
   - **情況 B**：TP 訂單失敗，使用 Taker 市價單 (最差情況)
     - Taker 費率：0.02%
     - 成本：$0.01 * 0.0002 = $0.00002
     - **總成本 (Maker+Taker)**: ~$0.000022

3. **Spread 成本**
   - 當前 Spread：0.028%
   - 每筆交易 Spread 成本：$0.01 * 0.00028 = $0.000028

4. **總成本範圍**
   - **最佳情況** (Maker+Maker): $0.000004 + $0.000028 = **$0.000032** (0.00032%)
   - **最差情況** (Maker+Taker): $0.000022 + $0.000028 = **$0.00005** (0.0005%)

### 實際盈利需求

要覆蓋成本並獲利，TP 訂單的價格差必須：

- **絕對最小值**：0.0005% (覆蓋最差情況)
- **建議最小值**：0.001% (0.01%) (提供安全邊際)
- **保守值**：0.002% (0.02%) (較好的風險調整回報)

### 換算成 Tick

假設 YZY 的 tick_size = 0.00001 (從訂單簿看是這個精度)

- **價格範圍**：約 $0.38
- **1 tick 的百分比**：0.00001 / 0.38 = **0.0026%** (約 0.003%)
- **2 ticks 的百分比**：0.00002 / 0.38 = **0.0053%** (約 0.005%)
- **3 ticks 的百分比**：0.00003 / 0.38 = **0.0079%** (約 0.008%)

**結論**：
- ✅ **1 tick** 應該**剛好覆蓋**成本 (0.0026% > 0.0005%)
- ⚠️ **但沒有安全邊際**，任何滑點都會導致虧損
- ✅ **2-3 ticks** 是**較安全的選擇**

## 問題診斷

### 當前參數評估

從日誌看，您可能在使用：
- `--take-profit-tick 10` (BTC)
- `--take-profit-tick 5` 或其他值 (YZY)

**如果 take-profit-tick 太大**：
- TP 價格離市場太遠，難以成交
- 導致大量使用 Taker 市價單平倉
- **這是虧損的主要原因！**

**如果 take-profit-tick 太小**：
- TP 價格太接近市場，容易被 POST-ONLY 拒絕
- 頻繁重試造成延遲

### 當前問題

從您的日誌和圖片看到：

1. **TP 訂單失敗率高**
   - Phase 1 經常失敗
   - 需要進入 Phase 2 或市場單
   - 增加了 Taker 費用成本

2. **價格震盪**
   - 價格在震盪，TP 訂單可能來不及成交就逆轉
   - 持倉時間延長，增加 Funding 成本

3. **持倉時間**
   - 有 1,365.8 YZY 空倉，未實現虧損
   - 如果持倉時間長，Funding 成本也會累積

## 優化建議

### 方案 1: 調整 TP Tick 參數（推薦）

```bash
# 對於 YZY (價格 ~$0.38)
python runbot_tick.py \
  --exchange lighter \
  --ticker YZY \
  --quantity 100 \
  --take-profit-tick 2 \      # 降低到 2-3 ticks (0.005-0.008%)
  --grid-step-tick 4 \        # 對應調整網格
  --max-orders 20 \           # 減少同時持倉數
  --wait-time 60
```

**理由**：
- 2 ticks = 0.005% > 0.0005% (足夠覆蓋成本)
- 3 ticks = 0.008% (有安全邊際)
- TP 訂單更容易成交，減少 Taker 市價單使用

### 方案 2: 減少交易頻率

```bash
# 增加 wait_time，減少開倉頻率
--wait-time 300 \             # 5 分鐘而不是 1 分鐘
--max-orders 10 \             # 減少同時持倉
```

**理由**：
- 減少過度交易
- 讓 TP 訂單有更多時間成交
- 降低總手續費

### 方案 3: 使用更保守的參數

```bash
# 使用百分比模式，更精確控制
python runbot.py \
  --exchange lighter \
  --ticker YZY \
  --quantity 100 \
  --take-profit 0.01 \        # 0.01% (足夠覆蓋所有成本)
  --grid-step 0.02 \          # 0.02% 網格間距
  --max-orders 15 \
  --wait-time 120
```

### 方案 4: 檢查持倉管理

**當前問題**：
- 有 1,365.8 YZY 空倉，未實現虧損 -$0.46
- 15 個掛單可能造成過度暴露

**建議**：
1. **減少 max_orders**：從 40 降到 15-20
2. **監控持倉時間**：如果 TP 訂單長時間未成交，考慮調整價格
3. **避免過度持倉**：在震盪市場中，小倉位更安全

## 立即行動建議

### 短期（現在就做）

1. **暫停當前機器人**或**降低 max_orders**
   ```bash
   # 將 max_orders 降到 10
   --max-orders 10
   ```

2. **檢查當前 TP 訂單成交率**
   - 查看日誌中 Phase 1 成功 vs Phase 2/市場單的比例
   - 如果 Phase 1 失敗率高，說明 TP tick 太大

3. **調整 take-profit-tick**
   ```bash
   # 對於 YZY，嘗試 2-3 ticks
   --take-profit-tick 2
   ```

### 中期（今天內）

1. **測試不同參數組合**
   - 測試 take-profit-tick = 2, 3, 4
   - 觀察哪個參數組合的成交率最高

2. **監控實際成本**
   - 計算 Maker vs Taker 訂單比例
   - 如果 Taker 比例 > 30%，說明 TP 太激進

3. **優化網格步長**
   - grid-step-tick 應該 ≥ 2 * take-profit-tick
   - 避免訂單太密集

### 長期（持續優化）

1. **動態調整參數**
   - 根據市場波動調整 TP tick
   - 高波動時增大，低波動時減小

2. **監控關鍵指標**
   - TP 訂單成交率（目標 >70%）
   - Maker/Taker 比例（目標 Maker >70%）
   - 持倉時間（目標 <5 分鐘）

3. **風險管理**
   - 設定止損邏輯
   - 限制最大持倉數
   - 監控資金使用率

## 計算工具

### 快速計算 TP Tick 需求

```python
# 假設
price = 0.38  # 當前價格
tick_size = 0.00001
maker_fee = 0.00002  # 0.002%
taker_fee = 0.0002   # 0.02%
spread = 0.00028     # 0.028%

# 總成本（最差情況）
total_cost_pct = taker_fee * 2 + spread  # 開倉maker + 平倉taker + spread
# = 0.00002 + 0.0002 + 0.00028 = 0.0005 = 0.05%

# 需要的 tick 數
min_tick = total_cost_pct * price / tick_size
# = 0.0005 * 0.38 / 0.00001 = 1.9 ticks ≈ 2 ticks

# 建議安全邊際
safe_tick = min_tick * 1.5  # 1.5倍安全邊際
# = 2 * 1.5 = 3 ticks
```

## 總結

**核心問題**：
1. ✅ TP tick 可能太大，導致 TP 訂單難以成交
2. ✅ 過度使用 Taker 市價單，手續費成本高
3. ✅ 持倉數太多，資金效率低
4. ✅ 在震盪市場中，參數不夠靈活

**解決方案**：
1. ✅ **降低 take-profit-tick 到 2-3** (確保覆蓋成本但容易成交)
2. ✅ **減少 max_orders 到 15-20** (降低風險)
3. ✅ **增加 wait_time** (減少過度交易)
4. ✅ **監控成交率** (確保 Maker 訂單比例高)

**目標**：
- TP 訂單成交率 > 70%
- Maker 訂單比例 > 70%
- 每筆交易淨利潤 > 0.001%






